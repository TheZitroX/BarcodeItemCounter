<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>iOS Kamera-Test + ZXing</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:16px;background:#f6f7fb}
    .wrap{max-width:760px;margin:0 auto}
    video{width:100%;background:#000;border-radius:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:12px 0}
    .btn{padding:10px 14px;border:1px solid #ccd;border-radius:10px;background:#fff;cursor:pointer}
    .ok{color:#0a7}
    .warn{color:#a70}
    .err{color:#c00;white-space:pre-wrap}
    code{background:#eef;padding:2px 6px;border-radius:6px}
    .kv{font-family:ui-monospace,Consolas,monospace;font-size:13px;background:#fff;border:1px dashed #ccd;padding:10px;border-radius:10px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>iOS Kamera-Test + ZXing</h1>
  <div class="kv" id="diag">…</div>

  <div class="row">
    <button class="btn" id="btnStart" type="button" onclick="startCamera()">Kamera starten</button>
    <button class="btn" id="btnStop"  type="button" onclick="stopCamera()">Stop</button>
  </div>

  <video id="vid" playsinline webkit-playsinline autoplay muted></video>

  <h3>Letzte Meldung</h3>
  <div id="msg" class="ok">Bereit.</div>

  <h3>Letzter Scan</h3>
  <div id="scan">—</div>
</div>

<!-- ZXing (UMD) -->
<script defer src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>
<script>
  const msg  = document.getElementById('msg');
  const diag = document.getElementById('diag');
  const vid  = document.getElementById('vid');
  const scanEl = document.getElementById('scan');

  let stream = null;
  let zxingControls = null;

  function logInfo(t){ msg.className='ok'; msg.textContent=t; console.log(t); }
  function logWarn(t){ msg.className='warn'; msg.textContent=t; console.warn(t); }
  function logErr(t){ msg.className='err'; msg.textContent=t; console.error(t); }

  function showDiag() {
    diag.textContent =
      `URL: ${location.href}
SecureContext: ${window.isSecureContext}
UserAgent: ${navigator.userAgent}
MediaDevices: ${!!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)}
Autoplay muted inline: gesetzt`;
  }
  showDiag();

  async function startCamera() {
    try {
      vid.setAttribute('muted', '');
      vid.muted = true;
      vid.playsInline = true;

      const constraints = {
        audio: false,
        video: {
          facingMode: 'environment',
          width:  { ideal: 1280 },
          height: { ideal: 720 }
        }
      };

      logInfo('Frage Kamera an …');
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      vid.srcObject = stream;

      try { await vid.play(); } catch(e){ }

      logInfo('Kamera läuft. Starte ZXing …');
      startZXing();
    } catch (e) {
      logErr(`getUserMedia ERROR: ${e.name} – ${e.message}
Hinweise:
• iOS verlangt HTTPS (GitHub Pages ist ok).
• In der Adressleiste Kamera-Erlaubnis prüfen (AA → Website-Einstellungen).
• Falls „Kein Zugriff“: Einstellungen > Safari/Chrome > Kamera → Erlauben.`);
    }
  }

  function stopCamera() {
    if (zxingControls) { zxingControls.stop(); zxingControls = null; }
    if (vid.srcObject) {
      vid.srcObject.getTracks().forEach(t => t.stop());
      vid.srcObject = null;
    }
    stream = null;
    logWarn('Kamera gestoppt.');
  }

  function startZXing() {
    if (!window.ZXingBrowser) { logErr('ZXing nicht geladen. Prüfe Script-URL.'); return; }
    const { BrowserMultiFormatReader, NotFoundException, DecodeHintType } = ZXingBrowser;

    const reader = new BrowserMultiFormatReader();
    const hints = new Map();
    hints.set(DecodeHintType.TRY_HARDER, true);
    reader.hints = hints;

    zxingControls = reader.decodeFromVideoElement(vid, (result, err, controls) => {
      if (result) {
        const fmt = result.getBarcodeFormat();
        const text = result.getText();
        scanEl.textContent = `${text}  [${ZXingBrowser.BarcodeFormat[fmt] || fmt}]`;
        try { navigator.vibrate && navigator.vibrate(30); } catch {}
      } else if (err && !(err instanceof NotFoundException)) {
        logWarn('ZXing Warnung: ' + err);
      }
    });

    logInfo('ZXing aktiv. Halte einen Code ins Bild.');
  }

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      if (vid && !vid.paused) vid.pause();
    } else {
      if (vid && vid.paused) vid.play().catch(()=>{});
    }
  });
</script>
</body>
</html>
