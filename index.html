<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ZXing Barcode Scanner</title>
  <style>
    body { margin:0; font-family: system-ui, sans-serif; background:#f6f7fb; }
    .wrap { max-width: 800px; margin: 0 auto; padding: 20px; }
    h1 { margin:0 0 12px; }
    video { width:100%; border-radius:12px; background:#000; }
    .row { display:flex; gap:8px; flex-wrap:wrap; margin:12px 0; }
    .btn { padding:10px 14px; border:1px solid #ccd; border-radius:10px; background:#fff; cursor:pointer; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { border-bottom:1px solid #eee; padding:6px; text-align:left; }
    .ok{color:#0a7} .err{color:#c00} .warn{color:#a70}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ZXing Barcode Scanner</h1>

  <div class="row">
    <button class="btn" id="btnStart">Start Camera</button>
    <button class="btn" id="btnStop">Stop</button>
    <button class="btn" id="btnReset">Reset</button>
    <button class="btn" id="btnExport">Export CSV</button>
    <span id="total" class="ok">Total: 0</span>
  </div>

  <video id="video" playsinline webkit-playsinline autoplay muted></video>
  <div id="status" class="warn">Ready.</div>

  <table>
    <thead><tr><th>Code</th><th>Format</th><th>Count</th></tr></thead>
    <tbody id="list"></tbody>
  </table>
</div>

<script type="module">
  import {
    BrowserMultiFormatReader,
    NotFoundException,
    BarcodeFormat,
    DecodeHintType
  } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/esm/index.min.js";

  const video = document.getElementById('video');
  const status = document.getElementById('status');
  const totalEl = document.getElementById('total');
  const listEl = document.getElementById('list');
  const btnStart = document.getElementById('btnStart');
  const btnStop = document.getElementById('btnStop');
  const btnReset = document.getElementById('btnReset');
  const btnExport = document.getElementById('btnExport');

  const reader = new BrowserMultiFormatReader();
  let controls = null;
  const counts = new Map();

  function render() {
    let total = 0;
    listEl.innerHTML = '';
    for (const [code, data] of counts.entries()) {
      total += data.count;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${code}</td><td>${data.format}</td><td>${data.count}</td>`;
      listEl.appendChild(tr);
    }
    totalEl.textContent = 'Total: ' + total;
  }

  function bump(code, format) {
    const entry = counts.get(code) || {count:0, format};
    entry.count++;
    counts.set(code, entry);
    render();
    status.textContent = 'Scanned: ' + code;
    status.className = 'ok';
  }

  function startCamera() {
    const hints = new Map();
    hints.set(DecodeHintType.TRY_HARDER, true);
    reader.hints = hints;

    controls = reader.decodeFromVideoDevice(
      undefined,
      video,
      (result, err) => {
        if (result) {
          bump(result.getText(), BarcodeFormat[result.getBarcodeFormat()]);
        } else if (err && !(err instanceof NotFoundException)) {
          status.textContent = 'Error: ' + err;
          status.className = 'err';
        }
      },
      {
        videoConstraints: {
          audio:false,
          video:{ facingMode:'environment', width:{ideal:1280}, height:{ideal:720} }
        }
      }
    );
    status.textContent = 'Camera started';
    status.className = 'warn';
  }

  function stopCamera() {
    if (controls) { controls.stop(); controls = null; }
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(t=>t.stop());
      video.srcObject = null;
    }
    status.textContent = 'Camera stopped';
    status.className = 'warn';
  }

  btnStart.onclick = startCamera;
  btnStop.onclick = stopCamera;
  btnReset.onclick = () => { counts.clear(); render(); };
  btnExport.onclick = () => {
    const rows = [['code','format','count']];
    for (const [code,data] of counts.entries()) {
      rows.push([code,data.format,data.count]);
    }
    const csv = rows.map(r=>r.join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'scans.csv'; a.click();
    URL.revokeObjectURL(url);
  };

  render();
</script>
</body>
</html>
