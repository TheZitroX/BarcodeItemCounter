<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ZXing Scanner (robust)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:16px;background:#f6f7fb}
    .wrap{max-width:760px;margin:0 auto}
    video{width:100%;background:#000;border-radius:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:12px 0}
    .btn{padding:10px 14px;border:1px solid #ccd;border-radius:10px;background:#fff;cursor:pointer}
    .ok{color:#0a7}.warn{color:#a70}.err{color:#c00;white-space:pre-wrap}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid #e8e8e8;padding:6px;text-align:left}
    .badge{background:#eef;border:1px solid #dde;padding:6px 10px;border-radius:999px}
    code{background:#eef;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ZXing Scanner</h1>

  <div class="row">
    <button class="btn" id="btnStart" type="button" disabled>Start camera</button>
    <button class="btn" id="btnStop"  type="button">Stop</button>
    <button class="btn" id="btnReset" type="button">Reset</button>
    <button class="btn" id="btnCSV"   type="button">Export CSV</button>
    <button class="btn" id="btnTorch" type="button">Torch</button>
    <span class="badge">Total: <span id="total">0</span></span>
  </div>

  <video id="vid" playsinline webkit-playsinline autoplay muted></video>

  <h3>Status</h3>
  <div id="msg" class="warn">Loading ZXing…</div>

  <h3>Last scan</h3>
  <div id="scan">—</div>

  <h3>List</h3>
  <table>
    <thead><tr><th>Code</th><th>Format</th><th>Count</th><th>Actions</th></tr></thead>
    <tbody id="list"><tr><td colspan="4" style="color:#777">—</td></tr></tbody>
  </table>
</div>

<script type="module">
  const msg = document.getElementById('msg');
  const vid = document.getElementById('vid');
  const scanEl = document.getElementById('scan');
  const listEl = document.getElementById('list');
  const totalEl = document.getElementById('total');
  const btnStart = document.getElementById('btnStart');
  const btnStop  = document.getElementById('btnStop');
  const btnReset = document.getElementById('btnReset');
  const btnCSV   = document.getElementById('btnCSV');
  const btnTorch = document.getElementById('btnTorch');

  let ZX = null; // module namespace
  let stream = null;
  let zxingControls = null;
  const counts = new Map();
  let lastScan = { code: null, t: 0 };
  const DEBOUNCE_MS = 1200;

  const ok = t => { msg.className='ok'; msg.textContent=t; };
  const warn = t => { msg.className='warn'; msg.textContent=t; };
  const err = t => { msg.className='err'; msg.textContent=t; };

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
  function jsq(s){ return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }

  function renderList() {
    if (counts.size === 0) {
      listEl.innerHTML = '<tr><td colspan="4" style="color:#777">—</td></tr>';
      totalEl.textContent = '0';
      return;
    }
    let total = 0;
    const rows = [];
    for (const [code, d] of counts.entries()) {
      total += d.count;
      rows.push(
        `<tr>
          <td><code>${escapeHtml(code)}</code></td>
          <td>${d.format}</td>
          <td>${d.count}</td>
          <td>
            <button class="btn" onclick="inc('${jsq(code)}')">+1</button>
            <button class="btn" onclick="dec('${jsq(code)}')">-1</button>
            <button class="btn" onclick="delCode('${jsq(code)}')">Delete</button>
          </td>
        </tr>`
      );
    }
    listEl.innerHTML = rows.join('');
    totalEl.textContent = String(total);
  }
  window.inc = (code)=>{ const e=counts.get(code); if(!e) return; e.count++; renderList(); };
  window.dec = (code)=>{ const e=counts.get(code); if(!e) return; e.count=Math.max(0,e.count-1); renderList(); };
  window.delCode = (code)=>{ counts.delete(code); renderList(); };

  function bump(code, format) {
    const entry = counts.get(code) || { count: 0, format };
    entry.count += 1;
    entry.format = format;
    counts.set(code, entry);
    renderList();
    beep();
  }

  function beep(){
    try {
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type='square'; o.frequency.value=880;
      g.gain.setValueAtTime(0.05, ctx.currentTime);
      o.connect(g).connect(ctx.destination);
      o.start(); o.stop(ctx.currentTime+0.07);
    } catch {}
  }

  async function loadZXingWithFallback(timeoutMs=6000){
    const cdns = [
      "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/esm/index.min.js",
      "https://unpkg.com/@zxing/browser@0.1.5/esm/index.min.js"
    ];
    for (const url of cdns) {
      try {
        const mod = await Promise.race([
          import(/* @vite-ignore */ url),
          new Promise((_, rej)=>setTimeout(()=>rej(new Error('timeout')), timeoutMs))
        ]);
        return mod;
      } catch(e) {
        // try next
      }
    }
    throw new Error("ZXing failed to load from both CDNs");
  }

  // boot: load ZXing first; then enable Start
  (async () => {
    try {
      ZX = await loadZXingWithFallback();
      ok('ZXing ready.');
      btnStart.disabled = false;
    } catch(e) {
      err(e.message);
      btnStart.disabled = true;
    }
  })();

  async function startCamera() {
    try {
      vid.setAttribute('muted',''); vid.muted = true; vid.playsInline = true;
      const constraints = { audio:false, video:{ facingMode:'environment', width:{ideal:1280}, height:{ideal:720} } };
      ok('Requesting camera…');
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      vid.srcObject = stream;
      try { await vid.play(); } catch(e){}

      if (!ZX) {
        err('ZXing not loaded.');
        return;
      }
      ok('Camera running. Starting ZXing…');
      startZXing();
    } catch (e) {
      err(`getUserMedia ERROR: ${e.name} – ${e.message}
• iOS requires HTTPS
• Check camera permission`);
    }
  }

  function stopCamera() {
    if (zxingControls) { zxingControls.stop(); zxingControls = null; }
    if (vid.srcObject) { vid.srcObject.getTracks().forEach(t=>t.stop()); vid.srcObject=null; }
    warn('Camera stopped.');
  }

  function startZXing() {
    const { BrowserMultiFormatReader, NotFoundException, DecodeHintType, BarcodeFormat } = ZX;

    const reader = new BrowserMultiFormatReader();
    const hints = new Map();
    hints.set(DecodeHintType.TRY_HARDER, true);
    reader.hints = hints;

    zxingControls = reader.decodeFromVideoElement(vid, (result, err) => {
      if (result) {
        const fmtEnum = result.getBarcodeFormat();
        const fmt = BarcodeFormat[fmtEnum] || String(fmtEnum);
        const text = result.getText();

        const now = Date.now();
        if (lastScan.code === text && (now - lastScan.t) < DEBOUNCE_MS) return;
        lastScan = { code: text, t: now };

        bump(text, fmt);
        scanEl.textContent = `${text}  [${fmt}]`;
        try { navigator.vibrate && navigator.vibrate(30); } catch {}
      } else if (err && !(err instanceof NotFoundException)) {
        warn('ZXing: ' + err);
      }
    });

    ok('ZXing active.');
  }

  function resetCounts(){ counts.clear(); renderList(); scanEl.textContent='—'; }
  function exportCSV(){
    const rows = [['code','format','count']];
    for (const [code,d] of counts.entries()) rows.push([code,d.format,d.count]);
    const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='scans.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  let torchOn = false;
  async function toggleTorch(){
    try {
      const track = vid.srcObject?.getVideoTracks?.()[0];
      if (!track) return;
      await track.applyConstraints({ advanced: [{ torch: !torchOn }] });
      torchOn = !torchOn;
      ok('Torch: ' + (torchOn?'on':'off'));
    } catch(e) {
      warn('Torch unsupported');
    }
  }

  btnStart.onclick = startCamera;
  btnStop.onclick  = stopCamera;
  btnReset.onclick = resetCounts;
  btnCSV.onclick   = exportCSV;
  btnTorch.onclick = toggleTorch;

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) { if (vid && !vid.paused) vid.pause(); }
    else { if (vid && vid.paused) vid.play().catch(()=>{}); }
  });

  renderList();
</script>
</body>
</html>
